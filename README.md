# é£ä¹¦å¼€æ”¾æ¥å£ SDK
ä¸ºå¸®åŠ©å¼€å‘è€…æ›´åŠ ä¾¿æ·åœ°ä½¿ç”¨é£ä¹¦å¼€æ”¾èƒ½åŠ›å¼€å‘åº”ç”¨ï¼Œç®€åŒ–åœ¨æ¥å…¥é£ä¹¦å¼€æ”¾å¹³å°æ—¶çš„æ“ä½œæ­¥éª¤ï¼Œå¼€æ”¾å¹³å°æä¾›äº†ç»Ÿä¸€çš„æœåŠ¡ç«¯ SDKã€‚å¼€å‘è€…å¯ä½¿ç”¨ SDKï¼Œå¿«æ·åœ°å¼€å‘åŠŸèƒ½ï¼Œæå‡å¼€å‘æ•ˆç‡ã€‚

## å®‰è£…
```shell
pip install lark-oapi -U
```
æ”¯æŒ Python 3.7 åŠä»¥ä¸Š

## ç®€å•ç¤ºä¾‹
```python
import lark_oapi as lark

# åˆ›å»ºclient
client = lark.Client.builder().app_id("APP_ID").app_secret("APP_SECRET").build()

# æ„é€ è¯·æ±‚å¯¹è±¡
request = lark.contact.v3.GetUserRequest.builder().user_id("7be5fg9a").build()

# å‘èµ·è¯·æ±‚
response = client.contact.v3.user.get(request)
```
æ›´å¤šç¤ºä¾‹å¯å‚è€ƒï¼š[è¯·æ±‚ç¤ºä¾‹](./samples/api)

## API Client
å¼€å‘è€…åœ¨è°ƒç”¨ API å‰ï¼Œéœ€è¦å…ˆåˆ›å»ºä¸€ä¸ª API Clientï¼Œç„¶åæ‰å¯ä»¥åŸºäº API Client å‘èµ· API è°ƒç”¨ã€‚

### åˆ›å»º Client
- è‡ªå»ºåº”ç”¨
```python
import lark_oapi as lark

client = lark.Client.builder() \
    .app_id("APP_ID") \
    .app_secret("APP_SECRET") \
    .build()
```

- å•†åº—åº”ç”¨
```python
import lark_oapi as lark

client = lark.Client.builder() \
    .app_id("APP_ID") \
    .app_secret("APP_SECRET") \
    .app_type(lark.AppType.ISV) \
    .build()
```

### Client é…ç½®é¡¹
åˆ›å»º API Client æ—¶ï¼Œå¯ä»¥å¯¹ API Client è¿›è¡Œä¸€å®šçš„é…ç½®ï¼Œæ¯”å¦‚æˆ‘ä»¬å¯ä»¥åœ¨åˆ›å»º API Client æ—¶è®¾ç½®æ—¥å¿—çº§åˆ«ã€http è¯·æ±‚è¶…æ—¶æ—¶é—´ç­‰ã€‚

```python
import lark_oapi as lark

client = lark.Client.builder() \
    .app_id("APP_ID") \
    .app_secret("APP_SECRET") \
    .domain(lark.FEISHU_DOMAIN) \       # åŸŸå, é»˜è®¤ä¸º https://open.feishu.cn
    .timeout(3) \                       # å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´, å•ä½ç§’, é»˜è®¤æ°¸ä¸è¶…æ—¶
    .app_type(lark.AppType.ISV) \       # åº”ç”¨ç±»å‹, é»˜è®¤ä¸ºè‡ªå»ºåº”ç”¨; è‹¥è®¾ä¸º ISV éœ€åœ¨ request_option ä¸­é…ç½® tenant_key
    .app_ticket("xxxx") \               # è·å– app_access_token å‡­è¯, app_type = ISV æ—¶éœ€é…ç½®
    .enable_set_token(False) \          # æ˜¯å¦å…è®¸æ‰‹åŠ¨è®¾ç½® token, é»˜è®¤ä¸å¼€å¯; å¼€å¯åéœ€åœ¨ request_option ä¸­é…ç½® token
    .cache(Cache()) \                   # è‡ªå®šä¹‰ç¼“å­˜, é»˜è®¤ä½¿ç”¨é¢„ç½®çš„æœ¬åœ°ç¼“å­˜
    .log_level(lark.LogLevel.DEBUG) \   # æ—¥å¿—çº§åˆ«, é»˜è®¤ä¸º WARNING
    .build()
```

## API è°ƒç”¨
åˆ›å»ºå®Œ API Client åï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ``client.ä¸šåŠ¡åŸŸ.ç‰ˆæœ¬.èµ„æº.æ–¹æ³•åç§°`` æ¥å®šä½å…·ä½“çš„ API æ–¹æ³•ï¼Œç„¶åå¯¹å…·ä½“çš„ API å‘èµ·è°ƒç”¨ã€‚

![client_expr](./doc/client_expr.png)

é£ä¹¦å¼€æ”¾å¹³å°å¼€æ”¾çš„æ‰€æœ‰ API
åˆ—è¡¨ï¼Œå¯ç‚¹å‡»[è¿™é‡ŒæŸ¥çœ‹](https://open.feishu.cn/document/ukTMukTMukTM/uYTM5UjL2ETO14iNxkTN/server-api-list)

### åŸºæœ¬ç”¨æ³•
å¦‚ä¸‹ç¤ºä¾‹ï¼Œæˆ‘ä»¬é€šè¿‡ client è°ƒç”¨ [é€šè¿‡æ‰‹æœºå·æˆ–é‚®ç®±è·å–ç”¨æˆ· ID](https://open.feishu.cn/document/server-docs/contact-v3/user/batch_get_id) æ¥å£ã€‚

```python
# Code generated by Lark OpenAPI.

import lark_oapi as lark
from lark_oapi.api.contact.v3 import *


client = lark.Client.builder() \
    .app_id("APP_ID") \
    .app_secret("APP_SECRET") \
    .log_level(lark.LogLevel.DEBUG) \
    .build()

# æ„é€ è¯·æ±‚å¯¹è±¡
request: BatchGetIdUserRequest = BatchGetIdUserRequest.builder() \
    .user_id_type("open_id") \
    .request_body(BatchGetIdUserRequestBody.builder()
                  .emails(["xxxx@bytedance.com"])
                  .mobiles(["15000000000"])
                  .build()) \
    .build()

# å‘èµ·è¯·æ±‚
response: BatchGetIdUserResponse = client.contact.v3.user.batch_get_id(request)

# å¤„ç†å¤±è´¥è¿”å›
if not response.success():
    lark.logger.error(
        f"client.contact.v3.user.batch_get_id failed, code: {response.code}, msg: {response.msg}, log_id: {response.get_log_id()}")

# å¤„ç†ä¸šåŠ¡ç»“æœ
lark.logger.info(lark.JSON.marshal(response.data, indent=4))
```
æ›´å¤šç¤ºä¾‹å¯å‚è€ƒï¼š[è¯·æ±‚ç¤ºä¾‹](./samples/api)

### Request é…ç½®é¡¹
åœ¨æ¯æ¬¡å‘èµ· API è°ƒç”¨æ—¶ï¼Œå¯ä»¥è®¾ç½®è¯·æ±‚çº§åˆ«çš„ä¸€äº›å‚æ•°ï¼Œæ¯”å¦‚ä¼ é€’ userAccessToken, è‡ªå®šä¹‰ headers ç­‰ã€‚

```python
import lark_oapi as lark
from lark_oapi.api.contact.v3 import *

# åˆ›å»ºclient
import lark_oapi as lark
from lark_oapi.api.contact.v3 import *

# åˆ›å»ºclient
client = lark.Client.builder() \
    .enable_set_token(True) \
    .log_level(lark.LogLevel.DEBUG) \
    .build()

# æ„é€ è¯·æ±‚å¯¹è±¡
request: BatchGetIdUserRequest = BatchGetIdUserRequest.builder() \
    .user_id_type("open_id") \
    .request_body(BatchGetIdUserRequestBody.builder()
                  .emails(["xxxx@bytedance.com"])
                  .mobiles(["15000000000"])
                  .build()) \
    .build()

# è®¾ç½®è¯·æ±‚é€‰é¡¹
headers = {"key1": "value1", "key2": "value2"}
req_opt = lark.RequestOption.builder()\
    .tenant_access_token("t-g1047hjTXIZKCBFYWXUCK3D2LJWZYCWYL7USXXXX")\
    .headers(headers)\
    .build()

# å‘èµ·è¯·æ±‚
response: BatchGetIdUserResponse = client.contact.v3.user.batch_get_id(request, req_opt)

# å¤„ç†å¤±è´¥è¿”å›
if not response.success():
    lark.logger.error(
        f"client.contact.v3.user.batch_get_id failed, code: {response.code}, msg: {response.msg}, log_id: {response.get_log_id()}")

# å¤„ç†ä¸šåŠ¡ç»“æœ
lark.logger.info(lark.JSON.marshal(response.data, indent=4))
```

å¦‚ä¸Šä½¿ç”¨ RequestOptions çš„ Builder æ¨¡å¼æ„å»ºè¯·æ±‚çº§åˆ«çš„å‚æ•°ã€‚å¦‚ä¸‹è¡¨æ ¼ï¼Œå±•ç¤ºäº†æ‰€æœ‰å¯è®¾ç½®çš„é€‰é¡¹ï¼š

<table>
  <thead align=left>
    <tr>
      <th>
        é…ç½®é€‰é¡¹
      </th>
       <th>
        æè¿°
      </th>
    </tr>
  </thead>
  <tbody align=left valign=top>
    <tr>
      <th>
        <code>tenant_key</code>
      </th>
      <td>ç§Ÿæˆ· key, å•†åº—åº”ç”¨å¿…é¡»è®¾ç½®è¯¥é€‰é¡¹ã€‚</td>
    </tr>
    <tr>
      <th>
        <code>user_access_token</code>
      </th>
      <td>ç”¨æˆ· tokenï¼Œåˆ›å»º Client æ—¶ enable_set_token éœ€è¦è®¾ç½®ä¸º Trueã€‚</td>
    </tr>
    <tr>
      <th>
        <code>tenant_access_token</code>
      </th>
      <td>ç§Ÿæˆ· tokenï¼Œåˆ›å»º Client æ—¶ enable_set_token éœ€è¦è®¾ç½®ä¸º Trueã€‚</td>
    </tr>
    <tr>
      <th>
        <code>app_access_token</code>
      </th>
      <td>åº”ç”¨ tokenï¼Œåˆ›å»º Client æ—¶ enable_set_token éœ€è¦è®¾ç½®ä¸º Trueã€‚</td>
    </tr>
    <tr>
      <th>
        <code>headers</code>
      </th>
      <td>è‡ªå®šä¹‰è¯·æ±‚å¤´ï¼Œè¿™äº›è¯·æ±‚å¤´ä¼šè¢«é€ä¼ åˆ°é£ä¹¦å¼€æ”¾å¹³å°æœåŠ¡ç«¯ã€‚</td
    </tr>
  </tbody>
</table>

### åŸç”Ÿæ–¹å¼è°ƒç”¨
éƒ¨åˆ†è€ç‰ˆæœ¬æ¥å£ï¼Œç”±äºæ²¡æœ‰å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ‰€ä»¥æ— æ³•ç”Ÿæˆå¯¹åº”çš„ SDK æ¨¡å‹ï¼Œéœ€è¦ä½¿ç”¨åŸç”Ÿæ–¹å¼è°ƒç”¨ã€‚

å¦‚ä¸‹ç¤ºä¾‹ï¼Œä½¿ç”¨ client åŸç”Ÿæ–¹å¼åŒæ ·è°ƒç”¨ [é€šè¿‡æ‰‹æœºå·æˆ–é‚®ç®±è·å–ç”¨æˆ· ID](https://open.feishu.cn/document/server-docs/contact-v3/user/batch_get_id) æ¥å£ã€‚

```python
import lark_oapi as lark


# åˆ›å»ºclient
client = lark.Client.builder() \
    .app_id("APP_ID") \
    .app_secret("APP_SECRET") \
    .log_level(lark.LogLevel.DEBUG) \
    .build()

# æ„é€ è¯·æ±‚å¯¹è±¡
request: lark.BaseRequest = lark.BaseRequest.builder() \
    .http_method(lark.HttpMethod.POST) \
    .uri("/open-apis/contact/v3/users/batch_get_id") \
    .token_types({lark.AccessTokenType.TENANT}) \
    .queries([("user_id_type", "open_id")]) \
    .body({"emails": ["xxxx@bytedance.com"], "mobiles": ["15000000000"]}) \
    .build()

# å‘èµ·è¯·æ±‚
response: lark.BaseResponse = client.request(request)

# å¤„ç†å¤±è´¥è¿”å›
if not response.success():
    lark.logger.error(
        f"client.request failed, code: {response.code}, msg: {response.msg}, log_id: {response.get_log_id()}")

# å¤„ç†ä¸šåŠ¡ç»“æœ
lark.logger.info(str(response.raw.content, lark.UTF_8))
```
æ›´å¤šç¤ºä¾‹å¯å‚è€ƒï¼š[åŸç”Ÿè°ƒç”¨](samples/api/raw.py)

## å¤„ç†æ¶ˆæ¯äº‹ä»¶å›è°ƒ
äº†è§£æ¶ˆæ¯è®¢é˜…ç›¸å…³çš„çŸ¥è¯†ï¼Œå¯ä»¥ [ç‚¹å‡»è¿™é‡Œ](https://open.feishu.cn/document/ukTMukTMukTM/uUTNz4SN1MjL1UzM)

è·å–é£ä¹¦å¼€æ”¾å¹³å°å¼€æ”¾çš„æ‰€æœ‰äº‹ä»¶åˆ—è¡¨ï¼Œå¯ä»¥ [ç‚¹å‡»è¿™é‡Œ](https://open.feishu.cn/document/ukTMukTMukTM/uYDNxYjL2QTM24iN0EjN/event-list)
### åŸºæœ¬ç”¨æ³•
å¼€å‘è€…è®¢é˜…æ¶ˆæ¯äº‹ä»¶åï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç ï¼Œå¯¹é£ä¹¦å¼€æ”¾å¹³å°æ¨é€çš„æ¶ˆæ¯äº‹ä»¶è¿›è¡Œå¤„ç†ã€‚

å¦‚ä¸‹ç¤ºä¾‹ä¸­ä½¿ç”¨ flask å¯åŠ¨ httpServerï¼Œå¦‚ä½¿ç”¨å…¶ä»– web æ¡†æ¶ï¼Œåªéœ€å¤„ç† http å‡ºå…¥å‚è½¬æ¢å³å¯ã€‚

```python
from flask import Flask

import lark_oapi as lark
from lark_oapi.adapter.flask import *
from lark_oapi.api.im.v1 import *

app = Flask(__name__)


def do_p2_im_message_receive_v1(data: P2ImMessageReceiveV1) -> None:
    print(lark.JSON.marshal(data))


def do_customized_event(data: lark.CustomizedEvent) -> None:
    print(lark.JSON.marshal(data))


handler = lark.EventDispatcherHandler.builder(lark.ENCRYPT_KEY, lark.VERIFICATION_TOKEN, lark.LogLevel.DEBUG) \
    .register_p2_im_message_receive_v1(do_p2_im_message_receive_v1) \
    .register_p1_customized_event("è¿™é‡Œå¡«å…¥ä½ è¦è‡ªå®šä¹‰è®¢é˜…çš„ event çš„ key,ä¾‹å¦‚ out_approval", do_customized_event) \
    .build()


@app.route("/event", methods=["POST"])
def event():
    resp = handler.do(parse_req())
    return parse_resp(resp)


if __name__ == "__main__":
    app.run(port=7777)
```
å…¶ä¸­ EventDispatcherHandler.builder(encrypt_key: str, verification_token: str) æ–¹æ³•å‚æ•°ç”¨äºç­¾åéªŒè¯å’Œæ¶ˆæ¯è§£å¯†ä½¿ç”¨, å¯åœ¨ [å¼€å‘è€…åå°](https://open.feishu.cn/app?lang=zh-CN) ->ã€Œäº‹ä»¶è®¢é˜…ã€ä¸­æŸ¥çœ‹ã€‚

![console](doc/console.jpeg)

éœ€è¦æ³¨æ„çš„æ˜¯æ³¨å†Œå¤„ç†å™¨æ—¶ï¼Œæ¯”å¦‚ä½¿ç”¨ register_p2_im_message_receive_v1 æ³¨å†Œæ¥å—æ¶ˆæ¯äº‹ä»¶å›è°ƒæ—¶ï¼Œå…¶ä¸­çš„ P2 ä¸ºæ¶ˆæ¯åè®®ç‰ˆæœ¬ï¼Œå½“å‰é£ä¹¦å¼€æ”¾å¹³å°å­˜åœ¨ [ä¸¤ç§æ¶ˆæ¯åè®®](https://open.feishu.cn/document/ukTMukTMukTM/uUTNz4SN1MjL1UzM#8f960a4b) ï¼Œåˆ†åˆ«ä¸º 1.0 å’Œ 2.0ã€‚

å¦‚ä¸‹å›¾å¼€å‘è€…åœ¨æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨æ—¶ï¼Œéœ€ä» [äº‹ä»¶åˆ—è¡¨](https://open.feishu.cn/document/ukTMukTMukTM/uYDNxYjL2QTM24iN0EjN/event-list) ä¸­æŸ¥çœ‹è‡ªå·±éœ€è¦çš„æ˜¯å“ªç§åè®®çš„äº‹ä»¶ã€‚

å¦‚æœæ˜¯ 1.0 çš„æ¶ˆæ¯åè®®ï¼Œåˆ™æ³¨å†Œå¤„ç†å™¨æ—¶ï¼Œéœ€è¦æ‰¾ä»¥ register_p1_xxxx å¼€å¤´çš„ã€‚å¦‚æœæ˜¯ 2.0 çš„æ¶ˆæ¯åè®®ï¼Œåˆ™æ³¨å†Œå¤„ç†å™¨æ—¶ï¼Œéœ€è¦æ‰¾ä»¥ register_p2_xxxx å¼€å¤´çš„ã€‚

è‹¥åœ¨ SDK ä¸­æœªæ‰¾åˆ°å¤„ç†å™¨ï¼Œå¯ä½¿ç”¨ register_p1_customized_event æˆ– register_p2_customized_event æ³¨å†Œè‡ªå®šä¹‰äº‹ä»¶ã€‚

![event_prot](doc/event_prot.png)

æ›´å¤šç¤ºä¾‹å¯å‚è€ƒï¼š[äº‹ä»¶å›è°ƒ](samples/event)

## å¤„ç†å¡ç‰‡è¡Œä¸ºå›è°ƒ
å…³äºå¡ç‰‡è¡Œä¸ºç›¸å…³çš„çŸ¥è¯†ï¼Œå¯ç‚¹å‡»[è¿™é‡ŒæŸ¥çœ‹](https://open.feishu.cn/document/ukTMukTMukTM/uczM3QjL3MzN04yNzcDN)

### åŸºæœ¬ç”¨æ³•
å¼€å‘è€…å¯ä»¥ä½¿ç”¨ä¸‹é¢ä»£ç å¤„ç†å¡ç‰‡å›è°ƒï¼Œç¤ºä¾‹ä¸­ä½¿ç”¨ flask å¯åŠ¨ httpServerï¼Œå¦‚ä½¿ç”¨å…¶ä»– web æ¡†æ¶ï¼Œåªéœ€å¤„ç† http å‡ºå…¥å‚è½¬æ¢å³å¯ã€‚

```python
from typing import Any

from flask import Flask

import lark_oapi as lark
from lark_oapi.adapter.flask import *

app = Flask(__name__)


def do_interactive_card(data: lark.Card) -> Any:
    print(lark.JSON.marshal(data))
    content = {
        "header": {
            "title": {
                "tag": "plain_text",
                "content": "æ›´æ–°å¡ç‰‡æˆåŠŸ"
            },
            "template": "green"
        },
        "elements": [
            {
                "tag": "div",
                "text": {
                    "tag": "lark_md",
                    "content": "**Success!\næˆåŠŸå•¦ğŸ˜„**"
                }
            },
        ]
    }
    return content


handler = lark.CardActionHandler.builder(lark.ENCRYPT_KEY, lark.VERIFICATION_TOKEN, lark.LogLevel.DEBUG) \
    .register(do_interactive_card) \
    .build()


@app.route("/card", methods=["POST"])
def card():
    resp = handler.do(parse_req())
    return parse_resp(resp)


if __name__ == "__main__":
    app.run(port=7777)

```

æ›´å¤šç¤ºä¾‹å¯å‚è€ƒï¼š[äº‹ä»¶å›è°ƒ](samples/card)

## æ‰©å±•ç¤ºä¾‹
æˆ‘ä»¬è¿˜åŸºäº SDK å°è£…äº†å¸¸ç”¨çš„ API ç»„åˆè°ƒç”¨åŠä¸šåŠ¡åœºæ™¯ç¤ºä¾‹ï¼Œå¦‚ï¼š
* æ¶ˆæ¯
  * [å‘é€æ–‡ä»¶æ¶ˆæ¯](https://github.com/larksuite/oapi-sdk-python-demo/blob/main/composite_api/im/send_file.py)
  * [å‘é€å›¾ç‰‡æ¶ˆæ¯](https://github.com/larksuite/oapi-sdk-python-demo/blob/main/composite_api/im/send_image.py)
* é€šè®¯å½•
  * [è·å–éƒ¨é—¨ä¸‹æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨](https://github.com/larksuite/oapi-sdk-python-demo/blob/main/composite_api/contact/list_user_by_department.py)
* å¤šç»´è¡¨æ ¼
  * [åˆ›å»ºå¤šç»´è¡¨æ ¼åŒæ—¶æ·»åŠ æ•°æ®è¡¨](https://github.com/larksuite/oapi-sdk-python-demo/blob/main/composite_api/base/create_app_and_tables.py)
* ç”µå­è¡¨æ ¼
  * [å¤åˆ¶ç²˜è´´æŸä¸ªèŒƒå›´çš„å•å…ƒæ ¼æ•°æ®](https://github.com/larksuite/oapi-sdk-python-demo/blob/main/composite_api/sheets/copy_and_paste_by_range.py)
  * [ä¸‹è½½æŒ‡å®šèŒƒå›´å•å…ƒæ ¼çš„æ‰€æœ‰ç´ æåˆ—è¡¨](https://github.com/larksuite/oapi-sdk-python-demo/blob/main/composite_api/sheets/download_media_by_range.py)
* æ•™ç¨‹
  * [æœºå™¨äººè‡ªåŠ¨æ‹‰ç¾¤æŠ¥è­¦](https://github.com/larksuite/oapi-sdk-python-demo/blob/main/quick_start/robot) ([å¼€å‘æ•™ç¨‹](https://open.feishu.cn/document/home/message-development-tutorial/introduction))

æ›´å¤šç¤ºä¾‹å¯å‚è€ƒï¼šhttps://github.com/larksuite/oapi-sdk-python-demo

## License
MIT

## åŠ å…¥è®¨è®ºç¾¤
[_å•å‡»_](https://applink.feishu.cn/client/chat/chatter/add_by_link?link_token=575k28fa-2c12-400a-80c0-2d8924e00d38)æˆ–æ‰«ç åŠ å…¥è®¨è®ºç¾¤

<img src="doc/qrcode.png" width="200" alt="è®¨è®ºç¾¤">
